---
title: "Resubmission analyses"
pagetitle: "exp 1-2-3 | covariate analyses"
author: "Owen Morgan"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_document
---

<style type="text/css">
  body{
  font-family: Avenir;
  font-size: 12pt;
}
</style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      fig.align = "center", fig.width = 9,
                      fig.height = 6, results = "markup")
options(knitr.kable.NA = "")

cli.progress_show_after <- 0

## Do not use scientific notation until 9 decimal places.
options(scipen = 9, digits = 9)

# Suppress summarise info
options(dplyr.summarise.inform = FALSE)
```

```{r lib}
library(here)
library(tidyverse)
select <- dplyr::select
library(cli) # For printing error messages
library(glue)

library(lme4)
library(emmeans)
library(broom)
library(gt)

library(ggpubr) ## functions for plotting SD, SEM, CI.
library(ggbeeswarm)
library(patchwork)
library(ggh4x) ## for nested facets

library(knitr) # For include_graphics

source(here::here("lib", "util.R"))
source(here::here("lib", "demographics.R"))
source(here::here("lib", "plots-jepg.R"))

EXPERIMENT_DIR <- "resubmission_analyses"
source(here::here(EXPERIMENT_DIR, "lib", "load_process", "load_process.R"))
source(here::here(EXPERIMENT_DIR, "lib", "tests.R"))

interaction_stats <-
  function(model_with_interaction,
           model_with_no_interaction) {
    return(anova(model_with_interaction, model_with_no_interaction))
  }

plot_blue <- c("#337aB7")
plot_colors <- c("#4477AA",
                 "#EE6677",
                 "#CCBB44",
                 "#66CCEE",
                 "#AA3377",
                 "#228833",
                 "#BBBBBB")

middle_purple1 <- "#996F91" ## In between plot colors one and two
```

```{r config}
experiment_label <- "Resubmission analyses"

## Emmeans settings (use Satterthwaire approx. instead of default t-to-z for large df)
## See: Luke (2017). Evaluating significance in linear mixed-effects models in R
DF_METHOD <- "satterthwaite"
LMERTEST_LIMIT <- 500000

## Figure settings
DEFAULT_HEIGHT = 3
DEFAULT_WIDTH = 5

## Specify directories
proc_dir_e1 <- set_or_make_dir(label = "proc (e1)",
  here::here(EXPERIMENT_DIR, "data", "proc_exp_n1008")
)
proc_dir_e2 <- set_or_make_dir(label = "proc (e2)",
  here::here(EXPERIMENT_DIR, "data", "proc_exp_n1450")
)
fig_dir <- set_or_make_dir(label = "fig",
  here::here(EXPERIMENT_DIR, "figures")
)
manual_cache_dir <- set_or_make_dir(label = "manual cache",
 here::here(EXPERIMENT_DIR, "manual_cache")
)

# use_cached_figs <- T
use_cached_models <- F
use_cached_proc_data <- F
```

# {.tabset}
```{r load_data}
## Load "the data" with all subjects & AAH trials.
aah_long_e1 <- load_aah_long(proc_dir_e1) |> mutate(experiment = "one")
aah_long_e2 <- load_aah_long(proc_dir_e2) |> mutate(experiment = "two")
test_for_dupes(aah_long_e1, aah_long_e2)
aah_long <- bind_rows(aah_long_e1, aah_long_e2)

## Load summary data table
## with all subjects.
aah_summary_all_e1 <- read_tsv(here(proc_dir_e1, "aah_summary.tsv")) |> 
  mutate(experiment = "one")
aah_summary_all_e2 <- read_tsv(here(proc_dir_e2, "aah_summary.tsv")) |> 
  mutate(experiment = "two")
test_for_dupes(aah_summary_all_e1, aah_summary_all_e2)
aah_summary_all <- bind_rows(aah_summary_all_e1, aah_summary_all_e2)
```

```{r prepare_data}
# TODO: remove any code from this block that isn't used
# use_cached_proc_data <- FALSE
#### PREPARE SUMMARY DATA FOR DEMOGRAPHICS ANALYSES (NAVON EXCLUSIONS)
if (use_cached_proc_data == FALSE) {
  cli::cli_alert_info("Filtering summary data for analysis (no excluded subjects).")
  cli::cli_bullets(c(" " = "aah_summary_all -> aah_summary"))
  aah_summary <- aah_summary_all |>
    filter(
      (experiment == "two" & exclude_navon == 0) |
      (experiment == "one" & exclude == 0)
      ) |>
    select(-starts_with("exclude")) |>
    mutate(
      handedness_extremes = case_when(ehi == -100 ~ "Left",
                                      ehi == 100 ~ "Right",
                                      ehi > -100 &
                                        ehi < 100 ~ "Mixed")
    )
  saveRDS(aah_summary, here(manual_cache_dir, "aah_summary.rds"))
} else {
  aah_summary <- readRDS(here(manual_cache_dir, "aah_summary.rds"))
}

#### PREPARE TRIAL-LEVEL DATA FOR RT, ACCURACY ANALYSES
## Prepare "the data" (aah_long) for all analyses:
## Filter out practice trials, absent trials, and excluded subjects
## This data (all present trials, correct or incorrect) will be used for
## accuracy analyses
if (use_cached_proc_data == FALSE) {
cli::cli_alert_info("Filtering long navon data for analysis (no excluded subjects; experimental trials (not practice) only; target present only).")
aah <- aah_long |>
    filter(
      (experiment == "two" & exclude_navon == 0) |
      (experiment == "one" & exclude == 0)
      ) |>
  filter(block_type == "main" & target_present == "yes") |>
  select(-starts_with("exclude")) |>
  ## Recode "level", "target" for nicer printing.
  mutate(level = recode(level, global = "Global", local = "Local")) |>
  mutate(target = recode(target, square = "Square", rectangle = "Rectangle",
                         circle = "Circle")) |>
  rename(shape = target) |> 
  ## Code handedness extremes
  mutate(
    handedness_extremes = case_when(ehi == -100 ~ "Left",
                                    ehi == 100 ~ "Right",
                                    ehi > -100 & ehi < 100 ~ "Mixed")
    )
  saveRDS(aah, here(manual_cache_dir, "aah.rds"))
} else {
  aah <- readRDS(here(manual_cache_dir, "aah.rds"))
}

## For RT analyses, prepare dataset with only correct, present trials.
## In our RT model, we only care about correct responses to present trials.
if (use_cached_proc_data == FALSE) {
aah_correct <- aah |> filter(correct == T)
  saveRDS(aah_correct, here(manual_cache_dir, "aah_correct.rds"))
} else {
  aah_correct <- readRDS(here(manual_cache_dir, "aah_correct.rds"))
}

## Relevel field and level with RVF first (unintuitive for plotting),
## so that emmeans will show a positive number for LVF global bias.
if (use_cached_proc_data == FALSE) {
aah_for_rt_model <- aah_correct |>
  mutate(level = level |> factor(levels = c("Global", "Local")),
         field = field |> factor(levels = c("RVF", "LVF")))
  saveRDS(aah_for_rt_model, here(manual_cache_dir, "aah_for_rt__model.rds"))
} else {
  aah_for_rt_model <- readRDS(here(manual_cache_dir, "aah_for_rt__model.rds"))
}

## For accuracy analyses, prepare dataset will all present trials.
## Relevel field and level,
## so that emmeans will show a positive number for LVF global bias.
if (use_cached_proc_data == FALSE) {
aah_for_acc_model <- aah |>
  mutate(level = level |> factor(levels = c("Global", "Local")),
         field = field |> factor(levels = c("RVF", "LVF")))
  saveRDS(aah_for_acc_model, here(manual_cache_dir, "aah_for_acc__model.rds"))
} else {
  aah_for_acc_model <- readRDS(here(manual_cache_dir, "aah_for_acc__model.rds"))
}

#### PREPARE SUBJECT_LEVEL DATA FOR RT, ACCURACY ANALYSES
## Prepare subject-level data (RT)
if (use_cached_proc_data == FALSE) {
rt_subject <- aah_correct |> group_by(subject, field, level, handedness, experiment) |>
  summarize(rt = median(rt))
  saveRDS(rt_subject, here(manual_cache_dir, "rt_subject.rds"))
} else {
  rt_subject <- readRDS(here(manual_cache_dir, "rt_subject.rds"))
}


## Prepare subject-level LVF Global bias summary (RT)
if (use_cached_proc_data == FALSE) {
rt_1 <- rt_subject |>
  pivot_wider(names_from = c(field, level),
              values_from = rt) |>
  mutate(LVF_Global_Bias = (RVF_Global - RVF_Local) - (LVF_Global - LVF_Local)) |>
  mutate(all_one_group = "all_one_group")
  saveRDS(rt_1, here(manual_cache_dir, "rt_1.rds"))
} else {
  rt_1 <- readRDS(here(manual_cache_dir, "rt_1.rds"))
}
```

## Summary

<!-- *All p-values two-sided.* -->

Is there a significant effect of response hand congruence on RT?
Response hand congruency facilitated reaction times in Experiment 1 (10.28ms faster for congruent trials, 95/% CI [7.53, 13.03], p < .0001, two-sided), Experiment 2 (9.83ms, 95/% CI [7.33, 12.32], p > .0001, two-sided), and Experiment 1 and 2 combined (10.03ms, 95/% CI [8.18, 11.88], p < .0001, two-sided).

Does the effect of handedness on the interaction of field by level persist when controlling for response hand congruence?
The effect of handedness on the interaction of field by level persisted when controlling for response had congruence in Experiment 1 (11.65ms, 95/% CI [0.64, 22.67], p = .038, two-sided), Experiment 2 (20.41ms, 95/% CI [10.35, 30.46], p < .0001, two-sided), and Experiments 1 and 2 combined (15.34ms, 95/% CI [7.94, 22.74ms], p < .0001, two-sided).

Does the effect of handedness on the interaction of field by level persist when controlling for task order?
- Experiment 2 (FxLxH): 
- Experiment 3 (Exp 2, with DL laterality as a covariate; (FxLxH))
- Experiment 3 (effect of handedness on DL laterality; (FxLxH))


When controlling for both response hand and task order?
- Experiment 2 (FxLxH): 
- Experiment 3 (Exp 2, with DL laterality as a covariate; (FxLxH))
- Experiment 3 (effect of handedness on DL laterality; (DLxH))

## Model response hand congruence

```{r}
## Prepare variable: response hand congruence
aah_for_rt_model <- aah_for_rt_model |> 
  ## Create variable: response hand
  mutate(response_hand = 
           case_when(
             block_response == "slash" ~ "right",
             block_response == "z" ~ "left"
           )) |> 
  ## Create variable: response hand congruence
    mutate(response_hand_congruence = 
           case_when(
             (response_hand == "right" & field == "RVF")  ~ "congruent",
             (response_hand == "right" & field == "LVF")  ~ "incongruent",
             (response_hand == "left" & field == "LVF")  ~ "congruent",
             (response_hand == "left" & field == "RVF")  ~ "incongruent",
           ))
```


### Exp 1
```{r}
experiment_label <- "Experiment 1"
```

#### Demographics
<br>
```{r}
## Pool experiments, break up by handedness
demo_table <- aah_summary |>
  filter(experiment == "one") |> 
  group_by(handedness) |> 
  summarize(
            N = n(),
            `Age (years)` = report_mean_sd(age),
            `Education (years)` = report_mean_sd(education),
            `Sex (M/F/O)` = report_sex(sex),
            EHI = report_mean_sd(ehi)
  ) |> 
  rename(Handedness = handedness)

demo_table |>
  pretty_table(groupname_col = "experiment") |> 
  tab_header(title = "Demographics, Experiment 1", subtitle = "") |> 
  tab_footnote("Left: (EHI <= -40)  |  Mixed: (-40 < EHI < 40)  |  Right: (EHI >= 40)")
```
<br>

#### Stats

##### Main effect of response hand congruence?

`RT ~ field * level * handedness + response_hand_congruence + (1|subject)`
```{r}
model_label <- "E1_RT_RHC"
#### FxLxH (prepare model)
## Make a model with two handedness bins: Right and Left
if (use_cached_models == FALSE) {
  aah_for_rt_model_2bins <- aah_for_rt_model |> 
    filter(handedness %in% c("Right", "Left")) |> 
    filter(experiment == "one")
  rt_model_2bins <- lmer(
    rt ~ field*level*handedness
    + response_hand_congruence
    + (1 | subject),
    data = aah_for_rt_model_2bins
    )

  ## Manually cache model
  saveRDS(rt_model_2bins, here(manual_cache_dir, str_c(model_label, "_model.rds")))
  
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_model_2bins <- readRDS(here(manual_cache_dir, str_c(model_label, "_model.rds")))
}
```

```{r}
#### RT ~ RHC
if (use_cached_models == FALSE) {
## Estimate the effect of field for each level for each handedness group
rt_emm2 <- emmeans(rt_model_2bins, ~ response_hand_congruence, lmer.df = DF_METHOD,
                          lmerTest.limit = LMERTEST_LIMIT) |>
  contrast("revpairwise") |>
  summary(infer = T, adj = "none")
  saveRDS(rt_emm2, here(manual_cache_dir, str_c(model_label, "_emm.rds")))
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_emm2 <- readRDS(here(manual_cache_dir, str_c(model_label, "_emm.rds")))
}

rt_emm2 |>
  as_tibble() |> 
  format_p.value() |> 
  #arrange(handedness, level) |> 
  pretty_table() |>
  tab_header(title = "Effect of response hand congruence on RT") |>
  tab_footnote(footnote = "A positive number means faster RT for congruent trials",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = "Confidence level: 95%",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Two-sided, uncorrected",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))
```

```{r}
#### RT ~ RHC
if (use_cached_models == FALSE) {
## Estimate the effect of field for each level for each handedness group
rt_emm2 <- emmeans(rt_model_2bins, ~ response_hand_congruence, lmer.df = DF_METHOD,
                          lmerTest.limit = LMERTEST_LIMIT) |>
  summary(infer = T, adj = "none")
  saveRDS(rt_emm2, here(manual_cache_dir, str_c(model_label, "emm_marginal.rds")))
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_emm2 <- readRDS(here(manual_cache_dir, str_c(model_label, "emm_marginal.rds")))
}

rt_emm2 |>
  as_tibble() |> 
  format_p.value() |> 
  rename(estimate = emmean) |> 
  #arrange(handedness, level) |> 
  pretty_table() |>
  tab_header(title = "RT by response hand congruence") |>
  tab_footnote(footnote = "ms",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = "Confidence level: 95%",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Two-sided, uncorrected",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))
```

##### FxLxH, controling for response hand congruence

`RT ~ field * level * handedness + response_hand_congruence + (1|subject)`

```{r}
model_label <- "E1_RT_RHC_F_L_H"
#### FxLxH (prepare model)
## Make a model with two handedness bins: Right and Left
if (use_cached_models == FALSE) {
  aah_for_rt_model_2bins <- aah_for_rt_model |> 
    filter(handedness %in% c("Right", "Left")) |> 
    filter(experiment == "one")
  rt_model_2bins <- lmer(
    rt ~ field*level*handedness
    + response_hand_congruence
    + (1 | subject),
    data = aah_for_rt_model_2bins
    )
  
  ## Manually cache model
  saveRDS(rt_model_2bins, here(manual_cache_dir, str_c(model_label, "_model.rds")))
  
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_model_2bins <- readRDS(here(manual_cache_dir, str_c(model_label, "_model.rds")))
}
```
<br>
```{r}
### FxLxH
## Use emmeans() to test 3-way interaction.
if (use_cached_models == FALSE) {
  rt_interaction_emm <- emmeans(
    rt_model_2bins,
    ~ field * level * handedness,
    lmer.df = DF_METHOD,
    lmerTest.limit = LMERTEST_LIMIT
  ) |>
    contrast(interaction = c("consec")) |>
    summary(infer = T)
  saveRDS(rt_emm2, here(manual_cache_dir, str_c(model_label, "_emm.rds")))
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_interaction_emm <- readRDS(here(manual_cache_dir, str_c(model_label, "_emm.rds")))
}

rt_interaction_emm |>
  as_tibble() |>
  format_p.value() |> 
  pretty_table() |>
  tab_header(title = str_glue("{experiment_label}: Field by Level by Handedness (RT)"),
             subtitle = "Compare effect estimate to zero with emmeans()") |>
  tab_footnote(footnote = "A positive number means LVF global bias is stronger in right handers (as predicted by AAH)",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = "Two-sided",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Confidence level: 95%",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))
```

### Exp 2
```{r}
experiment_label <- "Experiment 2"
```

#### Demographics
<br>
```{r}
## Pool experiments, break up by handedness
demo_table <- aah_summary |>
  filter(experiment == "two") |> 
  group_by(handedness) |> 
  summarize(
            N = n(),
            `Age (years)` = report_mean_sd(age),
            `Education (years)` = report_mean_sd(education),
            `Sex (M/F/O)` = report_sex(sex),
            EHI = report_mean_sd(ehi)
  ) |> 
  rename(Handedness = handedness)

demo_table |>
  pretty_table(groupname_col = "experiment") |> 
  tab_header(title = "Demographics, Experiment 2", subtitle = "") |> 
  tab_footnote("Left: (EHI <= -40)  |  Mixed: (-40 < EHI < 40)  |  Right: (EHI >= 40)")
```
<br>

#### Stats

##### Main effect of response hand congruence?

`RT ~ field * level * handedness + response_hand_congruence + (1|subject)`
```{r}
model_label <- "E2_RT_RHC"
#### FxLxH (prepare model)
## Make a model with two handedness bins: Right and Left
if (use_cached_models == FALSE) {
  aah_for_rt_model_2bins <- aah_for_rt_model |> 
    filter(handedness %in% c("Right", "Left")) |> 
    filter(experiment == "two")
  rt_model_2bins <- lmer(
    rt ~ field*level*handedness
    + response_hand_congruence
    + (1 | subject),
    data = aah_for_rt_model_2bins
    )

  ## Manually cache model
  saveRDS(rt_model_2bins, here(manual_cache_dir, str_c(model_label, "_model.rds")))
  
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_model_2bins <- readRDS(here(manual_cache_dir, str_c(model_label, "_model.rds")))
}
```

```{r}
#### RT ~ RHC
if (use_cached_models == FALSE) {
## Estimate the effect of field for each level for each handedness group
rt_emm2 <- emmeans(rt_model_2bins, ~ response_hand_congruence, lmer.df = DF_METHOD,
                          lmerTest.limit = LMERTEST_LIMIT) |>
  contrast("revpairwise") |>
  summary(infer = T, adj = "none")
  saveRDS(rt_emm2, here(manual_cache_dir, str_c(model_label, "_emm.rds")))
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_emm2 <- readRDS(here(manual_cache_dir, str_c(model_label, "_emm.rds")))
}

rt_emm2 |>
  as_tibble() |> 
  format_p.value() |> 
  #arrange(handedness, level) |> 
  pretty_table() |>
  tab_header(title = "Effect of response hand congruence on RT") |>
  tab_footnote(footnote = "A positive number means faster RT for congruent trials",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = "Confidence level: 95%",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Two-sided, uncorrected",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))
```

```{r}
#### RT ~ RHC
if (use_cached_models == FALSE) {
## Estimate the effect of field for each level for each handedness group
rt_emm2 <- emmeans(rt_model_2bins, ~ response_hand_congruence, lmer.df = DF_METHOD,
                          lmerTest.limit = LMERTEST_LIMIT) |>
  summary(infer = T, adj = "none")
  saveRDS(rt_emm2, here(manual_cache_dir, str_c(model_label, "emm_marginal.rds")))
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_emm2 <- readRDS(here(manual_cache_dir, str_c(model_label, "emm_marginal.rds")))
}

rt_emm2 |>
  as_tibble() |> 
  format_p.value() |> 
  rename(estimate = emmean) |> 
  #arrange(handedness, level) |> 
  pretty_table() |>
  tab_header(title = "RT by response hand congruence") |>
  tab_footnote(footnote = "ms",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = "Confidence level: 95%",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Two-sided, uncorrected",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))
```

##### FxLxH, controling for response hand congruence

`RT ~ field * level * handedness + response_hand_congruence + (1|subject)`

```{r}
model_label <- "E2_RT_RHC_F_L_H"
#### FxLxH (prepare model)
## Make a model with two handedness bins: Right and Left
if (use_cached_models == FALSE) {
  aah_for_rt_model_2bins <- aah_for_rt_model |> 
    filter(handedness %in% c("Right", "Left")) |> 
    filter(experiment == "two")
  rt_model_2bins <- lmer(
    rt ~ field*level*handedness
    + response_hand_congruence
    + (1 | subject),
    data = aah_for_rt_model_2bins
    )
  
  ## Manually cache model
  saveRDS(rt_model_2bins, here(manual_cache_dir, str_c(model_label, "_model.rds")))
  
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_model_2bins <- readRDS(here(manual_cache_dir, str_c(model_label, "_model.rds")))
}
```
<br>
```{r}
### FxLxH
## Use emmeans() to test 3-way interaction.
if (use_cached_models == FALSE) {
  rt_interaction_emm <- emmeans(
    rt_model_2bins,
    ~ field * level * handedness,
    lmer.df = DF_METHOD,
    lmerTest.limit = LMERTEST_LIMIT
  ) |>
    contrast(interaction = c("consec")) |>
    summary(infer = T)
  saveRDS(rt_emm2, here(manual_cache_dir, str_c(model_label, "_emm.rds")))
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_interaction_emm <- readRDS(here(manual_cache_dir, str_c(model_label, "_emm.rds")))
}

rt_interaction_emm |>
  as_tibble() |>
  format_p.value() |> 
  pretty_table() |>
  tab_header(title = str_glue("{experiment_label}: Field by Level by Handedness (RT)"),
             subtitle = "Compare effect estimate to zero with emmeans()") |>
  tab_footnote(footnote = "A positive number means LVF global bias is stronger in right handers (as predicted by AAH)",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = "Two-sided",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Confidence level: 95%",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))
```
### Exp 1 + 2

```{r}
experiment_label <- "Experiments 1 and 2"
```

#### Demographics
<br>
```{r}
## Pool experiments, break up by handedness
demo_table <- aah_summary |>
  group_by(handedness) |> 
  summarize(
            N = n(),
            `Age (years)` = report_mean_sd(age),
            `Education (years)` = report_mean_sd(education),
            `Sex (M/F/O)` = report_sex(sex),
            EHI = report_mean_sd(ehi)
  ) |> 
  rename(Handedness = handedness)

demo_table |>
  pretty_table(groupname_col = "experiment") |> 
  tab_header(title = "Demographics, Experiments 1 and 2", subtitle = "") |> 
  tab_footnote("Left: (EHI <= -40)  |  Mixed: (-40 < EHI < 40)  |  Right: (EHI >= 40)")
```
<br>

#### Stats

##### Main effect of response hand congruence?

`RT ~ field * level * handedness * experiment + response_hand_congruence + (1|subject)`
```{r}
model_label <- "E1-2_RT_RHC"
#### FxLxH (prepare model)
## Make a model with two handedness bins: Right and Left
if (use_cached_models == FALSE) {
  aah_for_rt_model_2bins <- aah_for_rt_model |> 
    filter(handedness %in% c("Right", "Left"))
  rt_model_2bins <- lmer(
    rt ~ field*level*handedness
    + response_hand_congruence
    + (1 | subject),
    data = aah_for_rt_model_2bins
    )

  ## Manually cache model
  saveRDS(rt_model_2bins, here(manual_cache_dir, str_c(model_label, "_model.rds")))
  
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_model_2bins <- readRDS(here(manual_cache_dir, str_c(model_label, "_model.rds")))
}
```

```{r}
#### RT ~ RHC
if (use_cached_models == FALSE) {
## Estimate the effect of field for each level for each handedness group
rt_emm2 <- emmeans(rt_model_2bins, ~ response_hand_congruence, lmer.df = DF_METHOD,
                          lmerTest.limit = LMERTEST_LIMIT) |>
  contrast("revpairwise") |>
  summary(infer = T, adj = "none")
  saveRDS(rt_emm2, here(manual_cache_dir, str_c(model_label, "_emm.rds")))
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_emm2 <- readRDS(here(manual_cache_dir, str_c(model_label, "_emm.rds")))
}

rt_emm2 |>
  as_tibble() |> 
  format_p.value() |> 
  #arrange(handedness, level) |> 
  pretty_table() |>
  tab_header(title = "Effect of response hand congruence on RT") |>
  tab_footnote(footnote = "A positive number means faster RT for congruent trials",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = "Confidence level: 95%",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Two-sided, uncorrected",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))
```

```{r}
#### RT ~ RHC
if (use_cached_models == FALSE) {
## Estimate the effect of field for each level for each handedness group
rt_emm2 <- emmeans(rt_model_2bins, ~ response_hand_congruence, lmer.df = DF_METHOD,
                          lmerTest.limit = LMERTEST_LIMIT) |>
  summary(infer = T, adj = "none")
  saveRDS(rt_emm2, here(manual_cache_dir, str_c(model_label, "emm_marginal.rds")))
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_emm2 <- readRDS(here(manual_cache_dir, str_c(model_label, "emm_marginal.rds")))
}

rt_emm2 |>
  as_tibble() |> 
  format_p.value() |> 
  rename(estimate = emmean) |> 
  #arrange(handedness, level) |> 
  pretty_table() |>
  tab_header(title = "RT by response hand congruence") |>
  tab_footnote(footnote = "ms",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = "Confidence level: 95%",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Two-sided, uncorrected",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))
```

##### FxLxH, controling for response hand congruence

`RT ~ field * level * handedness + response_hand_congruence + (1|subject)`

```{r}
model_label <- "E1-2_RT_RHC_F_L_H"
#### FxLxH (prepare model)
## Make a model with two handedness bins: Right and Left
if (use_cached_models == FALSE) {
  aah_for_rt_model_2bins <- aah_for_rt_model |> 
    filter(handedness %in% c("Right", "Left"))
  rt_model_2bins <- lmer(
    rt ~ field*level*handedness
    + response_hand_congruence
    + (1 | subject),
    data = aah_for_rt_model_2bins
    )
  
  ## Manually cache model
  saveRDS(rt_model_2bins, here(manual_cache_dir, str_c(model_label, "_model.rds")))
  
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_model_2bins <- readRDS(here(manual_cache_dir, str_c(model_label, "_model.rds")))
}
```
<br>
```{r}
### FxLxH
## Use emmeans() to test 3-way interaction.
if (use_cached_models == FALSE) {
  rt_interaction_emm <- emmeans(
    rt_model_2bins,
    ~ field * level * handedness,
    lmer.df = DF_METHOD,
    lmerTest.limit = LMERTEST_LIMIT
  ) |>
    contrast(interaction = c("consec")) |>
    summary(infer = T)
  saveRDS(rt_emm2, here(manual_cache_dir, str_c(model_label, "_emm.rds")))
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_interaction_emm <- readRDS(here(manual_cache_dir, str_c(model_label, "_emm.rds")))
}

rt_interaction_emm |>
  as_tibble() |>
  format_p.value() |> 
  pretty_table() |>
  tab_header(title = str_glue("{experiment_label}: Field by Level by Handedness (RT)"),
             subtitle = "Compare effect estimate to zero with emmeans()") |>
  tab_footnote(footnote = "A positive number means LVF global bias is stronger in right handers (as predicted by AAH)",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = "Two-sided",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Confidence level: 95%",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))
```

## Model task order

### Exp 1

#### Demographics
```{r}

```

#### Stats


### Exp 2

### Exp 1 + 2

### Exp 3

#### FxLxH

#### DLxH

## Model both





<br>
